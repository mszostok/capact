name: Main branch

on:
  push:
    paths:
      - "**.go"
      - "**.py"
      - "go.mod"
      - "go.sum"
      - "**.graphql"
      - ".github/workflows/**"
      - "**.sh"
      - "Makefile"
      - "deploy/**"
      - "hub-js/**"
      - "Dockerfile"
      - "!**.md"
      - "**.yaml.tmpl"
    branches:
      - "main"
      - "release-*"

jobs:

  release-cli:
    name: Release the latest Capact CLIs
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Setup environment
        run: |
          . ./hack/ci/setup-env.sh
      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: ${{env.GO_VERSION}}
      - uses: actions/cache@v2
        with:
          # In order:
          # * Module download cache
          # * Build cache (Linux)
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      - name: Install upx 3.96
        run: |
          # Install UPX
          wget https://github.com/upx/upx/releases/download/v3.96/upx-3.96-amd64_linux.tar.xz
          tar -xf upx-3.96-amd64_linux.tar.xz

          # Compress files
          ./upx-3.96-amd64_linux/upx -V
          mv ./upx-3.96-amd64_linux/upx /usr/local/bin/upx
          upx -V
      - name: Set up GoReleaser
        run: go install github.com/goreleaser/goreleaser@v1.1.0
      - name: Set up GCS
        uses: google-github-actions/setup-gcloud@master
        with:
          service_account_key: ${{ secrets.CAPACT_GCS_CREDS }}
          export_default_credentials: true
      - name: Release latest CLI
        run: |
          make release-latest-binaries
      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: ${{ matrix.APP }}-${{github.sha}}
          path: ./bin
          retention-days: 1
